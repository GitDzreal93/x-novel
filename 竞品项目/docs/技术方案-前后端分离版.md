# ğŸ—ï¸ å‰åç«¯åˆ†ç¦»æŠ€æœ¯æ–¹æ¡ˆ

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ·ç«¯å±‚                              â”‚
â”‚  React 18 + Ant Design 5 + TypeScript                       â”‚
â”‚  - è·¯ç”±ç®¡ç† (React Router)                                   â”‚
â”‚  - çŠ¶æ€ç®¡ç† (Zustand + React Query)                          â”‚
â”‚  - å¯Œæ–‡æœ¬ç¼–è¾‘ (Tiptap)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP/HTTPS (RESTful API)
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æœåŠ¡ç«¯å±‚                              â”‚
â”‚  Go 1.21+ + Gin Framework                                     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  API Layer (Gin Router)                             â”‚    â”‚
â”‚  â”‚  - /api/v1/projects/*   (é¡¹ç›®ç®¡ç†)                  â”‚    â”‚
â”‚  â”‚  - /api/v1/chat/*        (AI å¯¹è¯)                   â”‚    â”‚
â”‚  â”‚  - /api/v1/writing/*     (å†™ä½œè¾…åŠ©)                  â”‚    â”‚
â”‚  â”‚  - /api/v1/review/*      (AI å®¡é˜…)                   â”‚    â”‚
â”‚  â”‚  - /api/v1/publish/*     (å‘å¸ƒå¹³å°)                  â”‚    â”‚
â”‚  â”‚  - /api/v1/promotion/*   (æ¨å¹¿å·¥å…·)                  â”‚    â”‚
â”‚  â”‚  - /api/v1/models/*      (æ¨¡å‹ç®¡ç†)                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Service Layer                                       â”‚    â”‚
â”‚  â”‚  - ProjectService    NovelService                   â”‚    â”‚
â”‚  â”‚  - ChatService       WritingService                 â”‚    â”‚
â”‚  â”‚  - ReviewService     PublishService                 â”‚    â”‚
â”‚  â”‚  - ModelService      PromotionService               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LLM Adapter Layer (å¤šæ¨¡å‹æ”¯æŒ)                      â”‚    â”‚
â”‚  â”‚  - OpenAI       - Claude                           â”‚    â”‚
â”‚  â”‚  - Gemini       - DeepSeek                         â”‚    â”‚
â”‚  â”‚  - é€šä¹‰åƒé—®     - æ–‡å¿ƒä¸€è¨€                         â”‚    â”‚
â”‚  â”‚  - ç™¾å·         - æ™ºè°± GLM                         â”‚    â”‚
â”‚  â”‚  - è‡ªå®šä¹‰ç«¯ç‚¹                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ GORM
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®å±‚                                â”‚
â”‚  PostgreSQL 15+                                             â”‚
â”‚                                                              â”‚
â”‚  - ç”¨æˆ·æ•°æ® (users, user_settings)                           â”‚
â”‚  - é¡¹ç›®æ•°æ® (projects, chapters, ...)                       â”‚
â”‚  - AI é…ç½® (model_configs, api_keys)                        â”‚
â”‚  - å¯¹è¯å†å² (chat_sessions, chat_messages)                  â”‚
â”‚  - å‘å¸ƒè®°å½• (publish_tasks, ...)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æŠ€æœ¯æ ˆè¯¦æƒ…

### å‰ç«¯æŠ€æœ¯æ ˆ
```typescript
{
  "æ¡†æ¶": "React 18 + TypeScript",
  "æ„å»ºå·¥å…·": "Vite",
  "UI ç»„ä»¶åº“": "Ant Design 5.x",
  "çŠ¶æ€ç®¡ç†": "Zustand + React Query",
  "è·¯ç”±": "React Router v6",
  "HTTP å®¢æˆ·ç«¯": "Axios",
  "å¯Œæ–‡æœ¬ç¼–è¾‘å™¨": "Tiptap",
  "å›¾è¡¨": "ECharts / Recharts",
  "è¡¨å•": "React Hook Form + Zod",
  "æ ·å¼": "Tailwind CSS + CSS Modules"
}
```

### åç«¯æŠ€æœ¯æ ˆ
```go
{
  "è¯­è¨€": "Go 1.21+",
  "Web æ¡†æ¶": "Gin",
  "ORM": "GORM",
  "æ•°æ®åº“": "PostgreSQL 15+",
  "ç¼“å­˜": "Redis (å¯é€‰ï¼Œç”¨äºå¯¹è¯ç¼“å­˜)",
  "é…ç½®ç®¡ç†": "Viper",
  "æ—¥å¿—": "Zap",
  "API æ–‡æ¡£": "Swagger",
  "è®¤è¯": "JWT",
  "CORS": "gin-contrib/cors"
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ER å›¾æ¦‚è§ˆ

```
users (ç”¨æˆ·è¡¨)
  â”‚
  â”œâ”€â”€ user_settings (ç”¨æˆ·è®¾ç½®)
  â”‚
  â”œâ”€â”€ projects (é¡¹ç›®è¡¨)
  â”‚     â”œâ”€â”€ chapters (ç« èŠ‚è¡¨)
  â”‚     â”œâ”€â”€ chat_sessions (èŠå¤©ä¼šè¯)
  â”‚     â”‚     â””â”€â”€ chat_messages (èŠå¤©æ¶ˆæ¯)
  â”‚     â”œâ”€â”€ review_records (å®¡é˜…è®°å½•)
  â”‚     â”œâ”€â”€ publish_tasks (å‘å¸ƒä»»åŠ¡)
  â”‚     â””â”€â”€ promotion_contents (æ¨å¹¿å†…å®¹)
  â”‚
  â””â”€â”€ model_configs (æ¨¡å‹é…ç½®)
```

### è¡¨ç»“æ„è®¾è®¡

```sql
-- ============================================
-- ç”¨æˆ·ç›¸å…³
-- ============================================

CREATE TABLE devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id VARCHAR(100) UNIQUE NOT NULL, -- æµè§ˆå™¨/è®¾å¤‡ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†
    device_info JSONB, -- è®¾å¤‡ä¿¡æ¯ï¼ˆUAã€å¹³å°ç­‰ï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_device_id (device_id)
);

CREATE TABLE device_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    theme VARCHAR(20) DEFAULT 'light', -- 'light' | 'dark'
    language VARCHAR(10) DEFAULT 'zh-CN',
    auto_save_enabled BOOLEAN DEFAULT true,
    auto_save_interval INT DEFAULT 30000, -- 30ç§’
    INDEX idx_device_id (device_id)
);

-- ============================================
-- æ¨¡å‹é…ç½®
-- ============================================

CREATE TABLE model_providers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL, -- 'openai', 'anthropic', 'google', etc.
    display_name VARCHAR(100) NOT NULL,
    base_url_template VARCHAR(500), -- API åŸºç¡€ URL æ¨¡æ¿
    supports_streaming BOOLEAN DEFAULT true,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE model_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    provider_id INT NOT NULL REFERENCES model_providers(id),
    model_name VARCHAR(100) NOT NULL, -- 'gpt-4', 'claude-3-opus', etc.
    api_key VARCHAR(500) NOT NULL,
    api_endpoint VARCHAR(500), -- è‡ªå®šä¹‰ç«¯ç‚¹
    temperature DECIMAL(3,2) DEFAULT 0.7,
    max_tokens INT DEFAULT 8192,
    timeout INT DEFAULT 600, -- ç§’
    is_default BOOLEAN DEFAULT false,

    -- ç”¨é€”åˆ†ç±»
    purpose VARCHAR(50) DEFAULT 'general', -- 'general' | 'chat' | 'writing' | 'review' | 'promotion'

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE (device_id, provider_id, model_name, purpose),
    INDEX idx_device_id (device_id),
    INDEX idx_purpose (purpose)
);

-- ============================================
-- é¡¹ç›®ç›¸å…³
-- ============================================

CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    topic TEXT,
    genre TEXT[], -- æ•°ç»„ç±»å‹ï¼Œå­˜å‚¨å¤šä¸ªç±»å‹
    number_of_chapters INT DEFAULT 100,
    word_number_per_chapter INT DEFAULT 3000,
    user_guidance TEXT,

    -- æ¶æ„æ•°æ®
    core_seed TEXT,
    character_dynamics TEXT,
    world_building TEXT,
    plot_architecture TEXT,
    character_state TEXT,
    architecture_generated BOOLEAN DEFAULT false,

    -- å¤§çº²æ•°æ®
    chapter_blueprint TEXT,
    blueprint_generated BOOLEAN DEFAULT false,

    -- ä¸Šä¸‹æ–‡æ•°æ®
    global_summary TEXT,

    -- å…³ç³»å›¾è°±æ•°æ®
    graph_data JSONB,

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'draft', -- 'draft' | 'writing' | 'completed' | 'published'

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_device_id (device_id),
    INDEX idx_status (status),
    INDEX idx_updated_at (updated_at DESC)
);

CREATE TABLE chapters (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    chapter_number INT NOT NULL,
    title VARCHAR(200),

    -- å¤§çº²ä¿¡æ¯
    blueprint_position VARCHAR(100),
    blueprint_purpose VARCHAR(100),
    blueprint_suspense VARCHAR(100),
    blueprint_foreshadowing TEXT,
    blueprint_twist_level VARCHAR(20),
    blueprint_summary TEXT,

    -- ç« èŠ‚å†…å®¹
    content TEXT,
    word_count INT DEFAULT 0,

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'not_started', -- 'not_started' | 'draft' | 'completed'
    is_finalized BOOLEAN DEFAULT false,

    -- åˆ†ææ•°æ®
    analysis JSONB, -- å­˜å‚¨ç« èŠ‚åˆ†æç»“æœ

    -- å…³ç³»å›¾è°±ï¼ˆç« èŠ‚ç‹¬ç«‹ï¼‰
    chapter_graph JSONB,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE (project_id, chapter_number),
    INDEX idx_project_id (project_id),
    INDEX idx_status (status)
);

-- ============================================
-- èŠå¤©ç›¸å…³
-- ============================================

CREATE TABLE chat_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE, -- å¯é€‰ï¼Œå…³è”é¡¹ç›®
    title VARCHAR(200),
    context_mode VARCHAR(20) DEFAULT 'general', -- 'creative' | 'building' | 'character' | 'general'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_device_id (device_id),
    INDEX idx_project_id (project_id)
);

CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES chat_sessions(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL, -- 'user' | 'assistant' | 'system'
    content TEXT NOT NULL,
    tokens_used INT,
    model_config_id UUID REFERENCES model_configs(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_session_id (session_id),
    INDEX idx_created_at (created_at)
);

-- ============================================
-- å®¡é˜…ç›¸å…³
-- ============================================

CREATE TABLE review_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,

    -- è¯„åˆ†æ•°æ®
    scores JSONB NOT NULL, -- { "story_completeness": 80, "character_development": 70, ... }

    -- åˆ†æç»“æœ
    highlights TEXT[], -- äº®ç‚¹åˆ—è¡¨
    issues TEXT[], -- é—®é¢˜åˆ—è¡¨
    suggestions TEXT[], -- å»ºè®®åˆ—è¡¨

    -- å¸‚åœºé¢„æµ‹
    audience_analysis JSONB, -- å—ä¼—åˆ†æ
    market_potential JSONB, -- å¸‚åœºæ½œåŠ›

    model_config_id UUID REFERENCES model_configs(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_project_id (project_id),
    INDEX idx_created_at (created_at DESC)
);

-- ============================================
-- å‘å¸ƒç›¸å…³
-- ============================================

CREATE TABLE publish_platforms (
    id SERIAL PRIMARY KEY,
    code VARCHAR(20) UNIQUE NOT NULL, -- 'qidian', 'jinjiang', etc.
    name VARCHAR(100) NOT NULL,
    api_endpoint VARCHAR(500),
    auth_type VARCHAR(20) DEFAULT 'oauth', -- 'oauth' | 'api_key' | 'custom'
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_platform_accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    platform_id INT NOT NULL REFERENCES publish_platforms(id),
    access_token TEXT, -- åŠ å¯†å­˜å‚¨
    refresh_token TEXT,
    auth_data JSONB, -- å…¶ä»–è®¤è¯æ•°æ®
    platform_username VARCHAR(100),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE (device_id, platform_id),
    INDEX idx_user_id (user_id)
);

CREATE TABLE publish_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
    platform_id INT NOT NULL REFERENCES publish_platforms(id),
    account_id UUID REFERENCES user_platform_accounts(id),

    -- å‘å¸ƒé…ç½®
    publish_mode VARCHAR(20) DEFAULT 'draft', -- 'draft' | 'publish'
    title VARCHAR(200),
    description TEXT,
    tags TEXT[],

    -- è¿›åº¦
    status VARCHAR(20) DEFAULT 'pending', -- 'pending' | 'processing' | 'success' | 'failed'
    progress INT DEFAULT 0, -- 0-100
    error_message TEXT,

    -- ç»“æœ
    published_url VARCHAR(500),
    platform_work_id VARCHAR(100),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_project_id (project_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);

-- ============================================
-- æ¨å¹¿ç›¸å…³
-- ============================================

CREATE TABLE promotion_contents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,

    -- å†…å®¹ç±»å‹
    content_type VARCHAR(20) NOT NULL, -- 'slice' | 'xiaohongshu' | 'wechat' | 'video_script' | 'weibo'
    content_subtype VARCHAR(50), -- '3min' | '1min' | '15s' for video scripts

    -- ç”Ÿæˆçš„å†…å®¹
    title VARCHAR(500),
    content TEXT,
    tags TEXT[],
    metadata JSONB, -- å­˜å‚¨é¢å¤–çš„å…ƒæ•°æ®ï¼ˆå¦‚å°é¢å›¾å»ºè®®ã€BGM ç­‰ï¼‰

    -- æ•ˆæœè¿½è¸ª
    published BOOLEAN DEFAULT false,
    published_at TIMESTAMP,
    click_count INT DEFAULT 0,
    conversion_count INT DEFAULT 0,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_project_id (project_id),
    INDEX idx_content_type (content_type),
    INDEX idx_created_at (created_at)
);

-- ============================================
-- ç³»ç»Ÿé…ç½®
-- ============================================

CREATE TABLE system_prompts (
    id SERIAL PRIMARY KEY,
    category VARCHAR(50) NOT NULL, -- 'architecture' | 'chapter' | 'chat' | 'polish' | 'review' | 'promotion'
    name VARCHAR(100) NOT NULL,
    template TEXT NOT NULL,
    variables JSONB, -- å®šä¹‰çš„å˜é‡
    is_active BOOLEAN DEFAULT true,
    version INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    UNIQUE (category, name, version),
    INDEX idx_category (category)
);
```

---

## ğŸ”§ åç«¯å®ç°

### é¡¹ç›®ç»“æ„

```
x-novel-server/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go              # å…¥å£æ–‡ä»¶
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ handler/             # HTTP å¤„ç†å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ user.go
â”‚   â”‚   â”‚   â”œâ”€â”€ project.go
â”‚   â”‚   â”‚   â”œâ”€â”€ chapter.go
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.go
â”‚   â”‚   â”‚   â”œâ”€â”€ writing.go
â”‚   â”‚   â”‚   â”œâ”€â”€ review.go
â”‚   â”‚   â”‚   â”œâ”€â”€ publish.go
â”‚   â”‚   â”‚   â”œâ”€â”€ promotion.go
â”‚   â”‚   â”‚   â””â”€â”€ model.go
â”‚   â”‚   â”œâ”€â”€ middleware/          # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ device.go         # è®¾å¤‡è¯†åˆ«ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ cors.go
â”‚   â”‚   â”‚   â”œâ”€â”€ logger.go
â”‚   â”‚   â”‚   â””â”€â”€ recovery.go
â”‚   â”‚   â””â”€â”€ router/              # è·¯ç”±é…ç½®
â”‚   â”‚       â””â”€â”€ router.go
â”‚   â”‚
â”‚   â”œâ”€â”€ service/                 # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ device_service.go
â”‚   â”‚   â”œâ”€â”€ project_service.go
â”‚   â”‚   â”œâ”€â”€ chapter_service.go
â”‚   â”‚   â”œâ”€â”€ chat_service.go
â”‚   â”‚   â”œâ”€â”€ writing_service.go
â”‚   â”‚   â”œâ”€â”€ review_service.go
â”‚   â”‚   â”œâ”€â”€ publish_service.go
â”‚   â”‚   â”œâ”€â”€ promotion_service.go
â”‚   â”‚   â””â”€â”€ model_service.go
â”‚   â”‚
â”‚   â”œâ”€â”€ llm/                     # LLM é€‚é…å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ adapter.go           # æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ openai.go            # OpenAI é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ anthropic.go         # Claude é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ google.go            # Gemini é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ custom.go            # è‡ªå®šä¹‰ç«¯ç‚¹é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ manager.go           # æ¨¡å‹ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ repository/              # æ•°æ®è®¿é—®å±‚
â”‚   â”‚   â”œâ”€â”€ device_repo.go
â”‚   â”‚   â”œâ”€â”€ project_repo.go
â”‚   â”‚   â”œâ”€â”€ chapter_repo.go
â”‚   â”‚   â”œâ”€â”€ chat_repo.go
â”‚   â”‚   â””â”€â”€ model_repo.go
â”‚   â”‚
â”‚   â”œâ”€â”€ model/                   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ device.go
â”‚   â”‚   â”œâ”€â”€ project.go
â”‚   â”‚   â”œâ”€â”€ chapter.go
â”‚   â”‚   â”œâ”€â”€ chat.go
â”‚   â”‚   â””â”€â”€ model.go
â”‚   â”‚
â”‚   â”œâ”€â”€ dto/                     # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ request.go
â”‚   â”‚   â””â”€â”€ response.go
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                  # é…ç½®
â”‚   â”‚   â”œâ”€â”€ config.go
â”‚   â”‚   â””â”€â”€ database.go
â”‚   â”‚
â”‚   â”œâ”€â”€ pkg/                     # å·¥å…·åŒ…
â”‚   â”‚   â”œâ”€â”€ logger/
â”‚   â”‚   â”œâ”€â”€ errors/
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ jwt/
â”‚   â”‚
â”‚   â””â”€â”€ prompts/                 # AI æç¤ºè¯æ¨¡æ¿
â”‚       â”œâ”€â”€ architecture.go
â”‚       â”œâ”€â”€ chapter.go
â”‚       â”œâ”€â”€ chat.go
â”‚       â”œâ”€â”€ polish.go
â”‚       â”œâ”€â”€ review.go
â”‚       â””â”€â”€ promotion.go
â”‚
â”œâ”€â”€ migrations/                   # æ•°æ®åº“è¿ç§»
â”‚   â””â”€â”€ 000001_init.up.sql
â”‚
â”œâ”€â”€ config/                       # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ config.yaml
â”‚   â””â”€â”€ config.dev.yaml
â”‚
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ Dockerfile
â””â”€â”€ README.md
```

### æ ¸å¿ƒä»£ç ç¤ºä¾‹

#### 1. LLM é€‚é…å™¨æ¥å£

```go
// internal/llm/adapter.go
package llm

import (
	"context"
	"io"
)

// ChatMessage èŠå¤©æ¶ˆæ¯
type ChatMessage struct {
	Role    string `json:"role"`
	Content string `json:"content"`
}

// ChatOptions èŠå¤©é€‰é¡¹
type ChatOptions struct {
	Temperature float64 `json:"temperature"`
	MaxTokens   int     `json:"max_tokens"`
	Stream      bool    `json:"stream"`
}

// StreamCallback æµå¼å›è°ƒå‡½æ•°
type StreamCallback func(chunk string, fullContent string)

// LLMAdapter LLM é€‚é…å™¨æ¥å£
type LLMAdapter interface {
	// ChatCompletion èŠå¤©è¡¥å…¨ï¼ˆéæµå¼ï¼‰
	ChatCompletion(ctx context.Context, messages []ChatMessage, options ChatOptions) (string, error)

	// StreamChatCompletion æµå¼èŠå¤©è¡¥å…¨
	StreamChatCompletion(ctx context.Context, messages []ChatMessage, options ChatOptions, callback StreamCallback) (string, error)

	// ValidateConfig éªŒè¯é…ç½®æ˜¯å¦æœ‰æ•ˆ
	ValidateConfig(apiKey, baseURL string) error
}
```

#### 2. OpenAI é€‚é…å™¨å®ç°

```go
// internal/llm/openai.go
package llm

import (
	"bufio"
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"strings"
)

type OpenAIAdapter struct {
	baseURL string
}

func NewOpenAIAdapter(baseURL string) *OpenAIAdapter {
	if baseURL == "" {
		baseURL = "https://api.openai.com/v1"
	}
	return &OpenAIAdapter{baseURL: baseURL}
}

func (a *OpenAIAdapter) ChatCompletion(ctx context.Context, messages []ChatMessage, options ChatOptions) (string, error) {
	reqBody := map[string]interface{}{
		"model":       "gpt-4", // ä»é…ç½®è·å–
		"messages":    messages,
		"temperature": options.Temperature,
		"max_tokens":  options.MaxTokens,
		"stream":      false,
	}

	jsonData, _ := json.Marshal(reqBody)
	req, _ := http.NewRequestWithContext(ctx, "POST", a.baseURL+"/chat/completions", bytes.NewReader(jsonData))
	req.Header.Set("Content-Type", "application/json")
	req.Header.Set("Authorization", "Bearer YOUR_API_KEY")

	client := &http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		return "", err
	}
	defer resp.Body.Close()

	body, _ := io.ReadAll(resp.Body)
	var result map[string]interface{}
	json.Unmarshal(body, &result)

	// è§£æå“åº”...
	return "", nil
}

func (a *OpenAIAdapter) StreamChatCompletion(ctx context.Context, messages []ChatMessage, options ChatOptions, callback StreamCallback) (string, error) {
	reqBody := map[string]interface{}{
		"model":       "gpt-4",
		"messages":    messages,
		"temperature": options.Temperature,
		"max_tokens":  options.MaxTokens,
		"stream":      true,
	}

	jsonData, _ := json.Marshal(reqBody)
	req, _ := http.NewRequestWithContext(ctx, "POST", a.baseURL+"/chat/completions", bytes.NewReader(jsonData))
	req.Header.Set("Content-Type", "application/json")
	req.Header.Set("Authorization", "Bearer YOUR_API_KEY")

	client := &http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		return "", err
	}
	defer resp.Body.Close()

	scanner := bufio.NewScanner(resp.Body)
	var fullContent string

	for scanner.Scan() {
		line := scanner.Text()
		if strings.HasPrefix(line, "data: ") {
			data := strings.TrimPrefix(line, "data: ")
			if data == "[DONE]" {
				continue
			}

			var streamResp map[string]interface{}
			json.Unmarshal([]byte(data), &streamResp)

			choices := streamResp["choices"].([]interface{})
			if len(choices) > 0 {
				choice := choices[0].(map[string]interface{})
				delta := choice["delta"].(map[string]interface{})
				if content, ok := delta["content"].(string); ok {
					fullContent += content
					callback(content, fullContent)
				}
			}
		}
	}

	return fullContent, nil
}

func (a *OpenAIAdapter) ValidateConfig(apiKey, baseURL string) error {
	// å®ç°éªŒè¯é€»è¾‘
	return nil
}
```

#### 3. æ¨¡å‹ç®¡ç†å™¨

```go
// internal/llm/manager.go
package llm

import (
	"context"
	"your-project/internal/repository"
	"your-project/internal/model"
)

type ModelManager struct {
	modelRepo *repository.ModelRepository
}

func NewModelManager(modelRepo *repository.ModelRepository) *ModelManager {
	return &ModelManager{modelRepo: modelRepo}
}

// GetAdapter æ ¹æ®é…ç½®è·å–å¯¹åº”çš„é€‚é…å™¨
func (m *ModelManager) GetAdapter(config *model.ModelConfig) (LLMAdapter, error) {
	switch config.Provider.Name {
	case "openai":
		return NewOpenAIAdapter(config.APIEndpoint), nil
	case "anthropic":
		return NewAnthropicAdapter(config.APIEndpoint), nil
	case "google":
		return NewGoogleAdapter(config.APIEndpoint), nil
	default:
		// ä½¿ç”¨ OpenAI å…¼å®¹åè®®
		return NewCustomAdapter(config.APIEndpoint), nil
	}
}

// GetModelForPurpose æ ¹æ®ç”¨é€”è·å–æ¨¡å‹é…ç½®
func (m *ModelManager) GetModelForPurpose(ctx context.Context, userID string, purpose string) (*model.ModelConfig, LLMAdapter, error) {
	config, err := m.modelRepo.GetByUserAndPurpose(ctx, userID, purpose)
	if err != nil {
		return nil, nil, err
	}

	adapter, err := m.GetAdapter(config)
	if err != nil {
		return nil, nil, err
	}

	return config, adapter, nil
}
```

#### 4. API è·¯ç”±é…ç½®

```go
// internal/api/router/router.go
package router

import (
	"your-project/internal/api/handler"
	"your-project/internal/api/middleware"

	"github.com/gin-gonic/gin"
)

func SetupRouter(r *gin.Engine) {
	// CORS ä¸­é—´ä»¶
	r.Use(middleware.CORS())
	r.Use(middleware.Logger())
	r.Use(middleware.Recovery())

	// è®¾å¤‡è¯†åˆ«ä¸­é—´ä»¶ï¼ˆæ— éœ€è®¤è¯ï¼‰
	r.Use(middleware.Device())

	// API v1
	v1 := r.Group("/api/v1")
	{
		// è®¾å¤‡ç›¸å…³
		device := v1.Group("/device")
		{
			device.GET("/info", handler.GetDeviceInfo)
			device.GET("/settings", handler.GetDeviceSettings)
			device.PUT("/settings", handler.UpdateDeviceSettings)
		}

		// æ¨¡å‹é…ç½®
		models := v1.Group("/models")
		{
			models.GET("", handler.ListModelConfigs)
			models.POST("", handler.CreateModelConfig)
			models.PUT("/:id", handler.UpdateModelConfig)
			models.DELETE("/:id", handler.DeleteModelConfig)
			models.POST("/validate", handler.ValidateModelConfig)
		}

		// é¡¹ç›®
		projects := v1.Group("/projects")
		{
			projects.GET("", handler.ListProjects)
			projects.POST("", handler.CreateProject)
			projects.GET("/:id", handler.GetProject)
			projects.PUT("/:id", handler.UpdateProject)
			projects.DELETE("/:id", handler.DeleteProject)

			// é¡¹ç›®å­èµ„æº
			projects.GET("/:id/chapters", handler.ListChapters)
			projects.POST("/:id/chapters", handler.CreateChapter)
			projects.PUT("/:id/chapters/:chapterNum", handler.UpdateChapter)
			projects.GET("/:id/chapters/:chapterNum", handler.GetChapter)

			// æ¶æ„ç”Ÿæˆ
			projects.POST("/:id/architecture/generate", handler.GenerateArchitecture)

			// å¤§çº²ç”Ÿæˆ
			projects.POST("/:id/blueprint/generate", handler.GenerateBlueprint)

			// å¯¼å‡º
			projects.GET("/:id/export/:format", handler.ExportProject)
		}

		// èŠå¤©
		chat := v1.Group("/chat")
		{
			chat.GET("/sessions", handler.ListChatSessions)
			chat.POST("/sessions", handler.CreateChatSession)
			chat.GET("/sessions/:id", handler.GetChatSession)
			chat.POST("/sessions/:id/messages", handler.SendMessage)
			chat.DELETE("/sessions/:id", handler.DeleteChatSession)
		}

		// å†™ä½œè¾…åŠ©
		writing := v1.Group("/writing")
		{
			writing.POST("/polish", handler.PolishText)
			writing.POST("/expand", handler.ExpandText)
			writing.POST("/suggest", handler.GetSuggestions)
			writing.POST("/analyze-chapter", handler.AnalyzeChapter)
			writing.POST("/detect-errors", handler.DetectErrors)
		}

		// AI å®¡é˜…
		review := v1.Group("/review")
		{
			review.POST("/:projectId/start", handler.StartReview)
			review.GET("/:projectId/records", handler.GetReviewRecords)
		}

		// å‘å¸ƒ
		publish := v1.Group("/publish")
		{
			publish.GET("/platforms", handler.ListPlatforms)
			publish.GET("/accounts", handler.GetDeviceAccounts)
			publish.POST("/accounts", handler.BindPlatformAccount)
			publish.DELETE("/accounts/:id", handler.UnbindPlatformAccount)
			publish.POST("/projects/:projectId/publish", handler.PublishProject)
			publish.GET("/tasks/:id", handler.GetPublishTask)
		}

		// æ¨å¹¿
		promotion := v1.Group("/promotion")
		{
			promotion.POST("/:projectId/slices", handler.GenerateSlices)
			promotion.POST("/:projectId/social-content", handler.GenerateSocialContent)
			promotion.GET("/:projectId/contents", handler.ListPromotionContents)
		}
	}
}

	// Swagger æ–‡æ¡£
	r.GET("/swagger/*any", gin.WrapHandler(swaggerHandler))
}
```

#### 5. é¡¹ç›®æœåŠ¡å±‚

```go
// internal/service/project_service.go
package service

import (
	"context"
	"your-project/internal/llm"
	"your-project/internal/repository"
	"your-project/internal/prompts"
	"your-project/internal/model"
)

type ProjectService struct {
	projectRepo   *repository.ProjectRepository
	chapterRepo   *repository.ChapterRepository
	modelManager  *llm.ModelManager
}

func NewProjectService(
	projectRepo *repository.ProjectRepository,
	chapterRepo *repository.ChapterRepository,
	modelManager *llm.ModelManager,
) *ProjectService {
	return &ProjectService{
		projectRepo:  projectRepo,
		chapterRepo:  chapterRepo,
		modelManager: modelManager,
	}
}

// GenerateArchitecture ç”Ÿæˆå°è¯´æ¶æ„
func (s *ProjectService) GenerateArchitecture(ctx context.Context, projectID string, userID string) error {
	project, err := s.projectRepo.GetByID(ctx, projectID)
	if err != nil {
		return err
	}

	// è·å–é…ç½®çš„æ¨¡å‹
	config, adapter, err := s.modelManager.GetModelForPurpose(ctx, userID, "architecture")
	if err != nil {
		return err
	}

	// æ„å»ºæç¤ºè¯
	prompt := prompts.ArchitecturePrompt(prompts.ArchitectureParams{
		Topic:           project.Topic,
		Genre:           project.Genre,
		NumberOfChapters: project.NumberOfChapters,
		WordNumber:      project.WordNumberPerChapter,
		UserGuidance:    project.UserGuidance,
	})

	// è°ƒç”¨ LLMï¼ˆåˆ†æ­¥ç”Ÿæˆï¼‰
	messages := []llm.ChatMessage{
		{Role: "system", Content: "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å°è¯´ä½œå®¶ã€‚"},
		{Role: "user", Content: prompt.CoreSeed},
	}

	coreSeed, err := adapter.ChatCompletion(ctx, messages, llm.ChatOptions{
		Temperature: 0.7,
		MaxTokens:   config.MaxTokens,
	})
	if err != nil {
		return err
	}

	// ç»§ç»­ç”Ÿæˆå…¶ä»–éƒ¨åˆ†...
	// characterDynamics, worldBuilding, plotArchitecture, characterState

	// æ›´æ–°é¡¹ç›®
	project.CoreSeed = coreSeed
	project.ArchitectureGenerated = true

	return s.projectRepo.Update(ctx, project)
}
```

---

## ğŸŒ å‰åç«¯äº¤äº’

### API å“åº”æ ¼å¼

```typescript
// src/types/api.ts

interface ApiResponse<T = any> {
  code: number
  message: string
  data?: T
  error?: string
  timestamp: number
}

interface PageResponse<T> {
  items: T[]
  total: number
  page: number
  pageSize: number
}

// åˆ†é¡µè¯·æ±‚å‚æ•°
interface PageParams {
  page?: number
  pageSize?: number
  sortBy?: string
  sortOrder?: 'asc' | 'desc'
}
```

### Axios é…ç½®

```typescript
// src/services/api/client.ts
import axios, { AxiosInstance, AxiosRequestConfig, AxiosError } from 'axios'
import { message } from 'antd'

const baseURL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8080/api/v1'

const client: AxiosInstance = axios.create({
  baseURL,
  timeout: 120000, // 2 åˆ†é’Ÿ
  headers: {
    'Content-Type': 'application/json'
  }
})

// è¯·æ±‚æ‹¦æˆªå™¨
client.interceptors.request.use(
  (config) => {
    // æ·»åŠ  token
    const token = localStorage.getItem('access_token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// å“åº”æ‹¦æˆªå™¨
client.interceptors.response.use(
  (response) => {
    const apiResponse = response.data

    // å¤„ç†ä¸šåŠ¡é”™è¯¯ç 
    if (apiResponse.code !== 0) {
      message.error(apiResponse.message || 'è¯·æ±‚å¤±è´¥')
      return Promise.reject(new Error(apiResponse.message))
    }

    return apiResponse.data
  },
  (error: AxiosError) => {
    // å¤„ç† HTTP é”™è¯¯
    if (error.response) {
      const status = error.response.status

      switch (status) {
        case 401:
          message.error('æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•')
          // è·³è½¬ç™»å½•é¡µ
          window.location.href = '/login'
          break
        case 403:
          message.error('æ²¡æœ‰æƒé™è®¿é—®')
          break
        case 404:
          message.error('è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨')
          break
        case 500:
          message.error('æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•')
          break
        default:
          message.error(error.response.data?.message || 'è¯·æ±‚å¤±è´¥')
      }
    } else if (error.request) {
      message.error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
    } else {
      message.error('è¯·æ±‚é…ç½®é”™è¯¯')
    }

    return Promise.reject(error)
  }
)

export default client
```

### API æœåŠ¡å°è£…

```typescript
// src/services/api/projects.ts
import client from './client'
import { ApiResponse } from '../types/api'

export interface Project {
  id: string
  title: string
  topic: string
  genre: string[]
  numberOfChapters: number
  wordNumberPerChapter: number
  userGuidance: string
  // ... å…¶ä»–å­—æ®µ
}

export interface CreateProjectRequest {
  title: string
  topic: string
  genre: string[]
  numberOfChapters: number
  wordNumberPerChapter: number
  userGuidance?: string
}

export const projectApi = {
  // è·å–é¡¹ç›®åˆ—è¡¨
  list: (params?: { page?: number; pageSize?: number; status?: string }) =>
    client.get<any, ApiResponse<Project[]>>('/projects', { params }),

  // åˆ›å»ºé¡¹ç›®
  create: (data: CreateProjectRequest) =>
    client.post<any, ApiResponse<Project>>('/projects', data),

  // è·å–é¡¹ç›®è¯¦æƒ…
  get: (id: string) =>
    client.get<any, ApiResponse<Project>>(`/projects/${id}`),

  // æ›´æ–°é¡¹ç›®
  update: (id: string, data: Partial<Project>) =>
    client.put<any, ApiResponse<Project>>(`/projects/${id}`, data),

  // åˆ é™¤é¡¹ç›®
  delete: (id: string) =>
    client.delete<any, ApiResponse<void>>(`/projects/${id}`),

  // ç”Ÿæˆæ¶æ„
  generateArchitecture: (id: string) =>
    client.post<any, ApiResponse<void>>(`/projects/${id}/architecture/generate`),

  // ç”Ÿæˆå¤§çº²
  generateBlueprint: (id: string) =>
    client.post<any, ApiResponse<void>>(`/projects/${id}/blueprint/generate`),

  // å¯¼å‡ºé¡¹ç›®
  export: (id: string, format: 'txt' | 'markdown') =>
    client.get<any, Blob>(`/projects/${id}/export/${format}`, {
      responseType: 'blob'
    })
}
```

---

## ğŸ” è®¤è¯æ–¹æ¡ˆ

### JWT Token å®ç°

```go
// internal/pkg/jwt/jwt.go
package jwt

import (
	"errors"
	"time"

	"github.com/golang-jwt/jwt/v5"
)

type Claims struct {
	UserID string `json:"user_id"`
	jwt.RegisteredClaims
}

type Manager struct {
	secretKey     string
	tokenDuration time.Duration
}

func NewManager(secretKey string, tokenDuration time.Duration) *Manager {
	return &Manager{
		secretKey:     secretKey,
		tokenDuration: tokenDuration,
	}
}

func (m *Manager) GenerateToken(userID string) (string, error) {
	claims := Claims{
		UserID: userID,
		RegisteredClaims: jwt.RegisteredClaims{
			ExpiresAt: time.Now().Add(m.tokenDuration),
			IssuedAt:  time.Now(),
		},
	}

	token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
	return token.SignedString([]byte(m.secretKey))
}

func (m *Manager) ValidateToken(tokenString string) (*Claims, error) {
	token, err := jwt.ParseWithClaims(tokenString, &Claims{}, func(token *jwt.Token) (interface{}, error) {
		if _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
			return nil, errors.New("unexpected signing method")
		}
		return []byte(m.secretKey), nil
	})

	if err != nil {
		return nil, err
	}

	if claims, ok := token.Claims.(*Claims); ok && token.Valid {
		return claims, nil
	}

	return nil, errors.New("invalid token")
}
```

### è®¤è¯ä¸­é—´ä»¶

```go
// internal/api/middleware/device.go
package middleware

import (
	"net/http"
	"crypto/sha256"
	"encoding/hex"
	"time"

	"github.com/gin-gonic/gin"
	"github.com/google/uuid"
)

func Device() gin.HandlerFunc {
	return func(c *gin.Context) {
		// ä»è¯·æ±‚å¤´æˆ– Cookie è·å–è®¾å¤‡ ID
		deviceID := c.GetHeader("X-Device-ID")
		if deviceID == "" {
			// å¦‚æœæ²¡æœ‰è®¾å¤‡ IDï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„
			deviceID = generateDeviceID()
		}

		// å°†è®¾å¤‡ ID å­˜å…¥ä¸Šä¸‹æ–‡
		c.Set("device_id", deviceID)
		c.Next()
	}
}

func generateDeviceID() string {
	// ç”ŸæˆåŸºäºæ—¶é—´æˆ³å’Œéšæœºæ•°çš„è®¾å¤‡ ID
	timestamp := time.Now().UnixNano()
	random := uuid.New().String()
	hash := sha256.Sum256([]byte(timestamp + random))
	return hex.EncodeToString(hash[:])[:32]
}
```

---

## ğŸ“Š æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ

### æŒä¹…åŒ–ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å­˜å‚¨ç­–ç•¥                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. PostgreSQL (ä¸»å­˜å‚¨)                                 â”‚
â”‚     â”œâ”€â”€ è®¾å¤‡æ•°æ®                                         â”‚
â”‚     â”œâ”€â”€ é¡¹ç›®æ•°æ®                                         â”‚
â”‚     â”œâ”€â”€ ç« èŠ‚å†…å®¹                                         â”‚
â”‚     â”œâ”€â”€ èŠå¤©å†å²                                         â”‚
â”‚     â””â”€â”€ å®¡é˜…/å‘å¸ƒ/æ¨å¹¿è®°å½•                                â”‚
â”‚                                                         â”‚
â”‚  2. Redis (å¯é€‰ï¼Œç”¨äºç¼“å­˜)                              â”‚
â”‚     â”œâ”€â”€ çƒ­ç‚¹é¡¹ç›®ç¼“å­˜                                      â”‚
â”‚     â”œâ”€â”€ ä¼šè¯ç¼“å­˜ (Session)                               â”‚
â”‚     â”œâ”€â”€ æµå¼å“åº”ä¸´æ—¶å­˜å‚¨                                   â”‚
â”‚     â””â”€â”€ API é™æµ                                         â”‚
â”‚                                                         â”‚
â”‚  3. æ–‡ä»¶å­˜å‚¨ (å¯¹è±¡å­˜å‚¨)                                 â”‚
â”‚     â”œâ”€â”€ å¯¼å‡ºçš„æ–‡ä»¶ (TXT/MD/PDF)                          â”‚
â”‚     â”œâ”€â”€ å°é¢å›¾ç‰‡                                         â”‚
â”‚     â””â”€â”€ æ¨å¹¿ç´ æ                                         â”‚
â”‚     â”œâ”€â”€ æœ¬åœ°å­˜å‚¨: /var/lib/x-novel/uploads              â”‚
â”‚     â””â”€â”€ äº‘å­˜å‚¨: OSS / S3 (å¯é…ç½®)                        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®åŒæ­¥ç­–ç•¥

```typescript
// å‰ç«¯ï¼šZustand + React Query æ··åˆæ¨¡å¼

// 1. Zustandï¼šç®¡ç† UI çŠ¶æ€ + æœ¬åœ°ç¼“å­˜
//    - å½“å‰é¡¹ç›®ä¿¡æ¯
//    - UI ä¸»é¢˜ã€åå¥½è®¾ç½®
//    - ç¼–è¾‘å™¨ä¸´æ—¶å†…å®¹ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰

// 2. React Queryï¼šç®¡ç†æœåŠ¡ç«¯çŠ¶æ€
//    - é¡¹ç›®åˆ—è¡¨
//    - èŠå¤©å†å²
//    - å®¡é˜…è®°å½•
//    - è‡ªåŠ¨é‡æ–°éªŒè¯
```

---

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### Docker Compose é…ç½®

```yaml
version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: x-novel-db
    environment:
      POSTGRES_DB: x_novel
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: your_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - x-novel-network

  # Redis ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
  redis:
    image: redis:7-alpine
    container_name: x-novel-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - x-novel-network

  # Go åç«¯æœåŠ¡
  server:
    build:
      context: ./x-novel-server
      dockerfile: Dockerfile
    container_name: x-novel-server
    environment:
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=admin
      - DATABASE_PASSWORD=your_password
      - DATABASE_NAME=x_novel
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - JWT_SECRET=your_jwt_secret
      - JWT_DURATION=24h
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - redis
    networks:
      - x-novel-network

  # React å‰ç«¯ï¼ˆå¼€å‘ç”¨ï¼‰
  web:
    build:
      context: ./x-novel-web
      dockerfile: Dockerfile.dev
    container_name: x-novel-web
    ports:
      - "3000:3000"
    volumes:
      - ./x-novel-web:/app
      - /app/node_modules
    environment:
      - VITE_API_BASE_URL=http://localhost:8080/api/v1
    depends_on:
      - server
    networks:
      - x-novel-network

volumes:
  postgres_data:
  redis_data:

networks:
  x-novel-network:
    driver: bridge
```

---

## ğŸ”‘ å¤šæ¨¡å‹é…ç½®ç®¡ç†

### æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨

```go
// internal/model/model.go
const (
	ProviderOpenAI    = "openai"
	ProviderAnthropic  = "anthropic"
	ProviderGoogle     = "google"
	ProviderDeepSeek   = "deepseek"
	ProviderQwen       = "qwen"
	ProviderBaidu      = "baidu"
	ProviderZhipu      = "zhipu"
	ProviderCustom     = "custom"
)

var AvailableModels = []ModelProvider{
	{
		Name:        ProviderOpenAI,
		DisplayName: "OpenAI",
		BaseURL:     "https://api.openai.com/v1",
		SupportsStreaming: true,
	},
	{
		Name:        ProviderAnthropic,
		DisplayName: "Anthropic (Claude)",
		BaseURL:     "https://api.anthropic.com/v1",
		SupportsStreaming: true,
	},
	{
		Name:        ProviderGoogle,
		DisplayName: "Google (Gemini)",
		BaseURL:     "https://generativelanguage.googleapis.com/v1",
		SupportsStreaming: true,
	},
	// ... æ›´å¤šæä¾›å•†
}
```

### ç”¨æˆ·è‡ªå®šä¹‰ç«¯ç‚¹

```go
// ç”¨æˆ·å¯ä»¥é…ç½®è‡ªå®šä¹‰çš„ OpenAI å…¼å®¹ç«¯ç‚¹
type CustomEndpointConfig struct {
	Name        string `json:"name" validate:"required"`
	BaseURL     string `json:"base_url" validate:"required,url"`
	APIKey      string `json:"api_key" validate:"required"`
	ModelName   string `json:"model_name" validate:"required"`
	// å¯é€‰ï¼šè¦†ç›–é»˜è®¤çš„è¯·æ±‚æ ¼å¼
	CustomHeaders map[string]string `json:"custom_headers"`
}
```

---

## ğŸ“ æ€»ç»“

### ä¼˜åŠ¿

1. **å‰åç«¯åˆ†ç¦»**
   - èŒè´£æ¸…æ™°ï¼Œä¾¿äºå›¢é˜Ÿåä½œ
   - å‰ç«¯å¯ç‹¬ç«‹è¿­ä»£
   - åç«¯å¯æ°´å¹³æ‰©å±•

2. **PostgreSQL æŒä¹…åŒ–**
   - æ”¯æŒ JSONB å­˜å‚¨å¤æ‚æ•°æ®
   - æ”¯æŒå…¨æ–‡æœç´¢
   - æ”¯æŒäº‹åŠ¡å’Œå…³ç³»çº¦æŸ

3. **å¤šæ¨¡å‹æ”¯æŒ**
   - ç»Ÿä¸€çš„é€‚é…å™¨æ¥å£
   - ç”¨æˆ·å¯è‡ªç”±åˆ‡æ¢
   - æ”¯æŒè‡ªå®šä¹‰ç«¯ç‚¹

4. **æ•°æ®å®‰å…¨**
   - API Key åŠ å¯†å­˜å‚¨
   - JWT è®¤è¯
   - ç”¨æˆ·æ•°æ®éš”ç¦»

### ä¸‹ä¸€æ­¥

éœ€è¦æˆ‘å¸®ä½ ï¼š
1. åˆå§‹åŒ– Go åç«¯é¡¹ç›®ï¼Ÿ
2. ç”Ÿæˆæ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼Ÿ
3. å®ç°å…·ä½“çš„ API æ¥å£ï¼Ÿ
4. å…¶ä»–ï¼Ÿ

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-27
