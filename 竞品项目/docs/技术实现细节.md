# ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚æ–‡æ¡£

## æ•°æ®ç»“æ„è®¾è®¡

### é¡¹ç›®æ•°æ®ç»“æ„

```javascript
// Novel Project Object
{
  // åŸºç¡€ä¿¡æ¯
  id: "å­—ç¬¦ä¸²æ—¶é—´æˆ³",
  createdAt: "ISOæ—¶é—´æˆ³",
  updatedAt: "ISOæ—¶é—´æˆ³",
  title: "é¡¹ç›®åç§°",
  topic: "å°è¯´ä¸»é¢˜/æ ¸å¿ƒåˆ›æ„",
  genre: ["ç„å¹»"] | ["éƒ½å¸‚", "è¨€æƒ…"],  // æ”¯æŒå¤šé€‰
  numberOfChapters: 100,  // 10-500
  wordNumber: 3000,       // 1000-10000
  userGuidance: "ç”¨æˆ·é¢å¤–æŒ‡å¯¼",

  // æ¶æ„æ•°æ®ï¼ˆ5 æ­¥éª¤ï¼‰
  coreSeed: "æ ¸å¿ƒç§å­æ–‡æœ¬",
  characterDynamics: "è§’è‰²ä½“ç³»æ–‡æœ¬",
  worldBuilding: "ä¸–ç•Œè§‚æ–‡æœ¬",
  plotArchitecture: "æƒ…èŠ‚æ¶æ„æ–‡æœ¬",
  characterState: "è§’è‰²çŠ¶æ€æ–‡æœ¬",

  // å¤§çº²æ•°æ®
  chapterBlueprint: "å®Œæ•´ç« èŠ‚å¤§çº²æ–‡æœ¬",

  // ç« èŠ‚å†…å®¹
  chapters: {
    "1": "ç¬¬ä¸€ç« æ­£æ–‡...",
    "5": "ç¬¬äº”ç« æ­£æ–‡...",
    // key: ç« èŠ‚å·, value: ç« èŠ‚æ–‡æœ¬
  },

  // ä¸Šä¸‹æ–‡æ•°æ®
  globalSummary: "å‰æ–‡æ‘˜è¦ï¼ˆç´¯ç§¯ï¼‰",

  // å…³ç³»å›¾è°±æ•°æ®
  graphData: {
    version: 1,
    generatedAt: "æ—¶é—´æˆ³",
    snapshots: {
      "0": {  // åŸºçº¿å¿«ç…§
        nodes: [
          {
            id: "char_zhangsan",
            label: "å¼ ä¸‰",
            type: "character" | "faction" | "location" | "item",
            importance: 8,  // 1-10
            faction: "é˜µè¥å" | null,
            status: "active" | "offline" | "deceased",
            bio: "ç®€ä»‹",
            traits: ["ç‰¹å¾1", "ç‰¹å¾2"],
            firstAppearance: 0
          }
        ],
        edges: [
          {
            id: "edge_x_y",
            source: "char_x",
            target: "char_y",
            relationType: "hostile" | "romantic" | "alliance" | "neutral" | "family" | "mentor",
            label: "å…³ç³»ç®€è¿°",
            strength: 7,  // 1-10
            description: "è¯¦ç»†æè¿°",
            events: ["äº‹ä»¶1", "äº‹ä»¶2"]
          }
        ]
      },
      "5": {  // ç¬¬5ç« å¿«ç…§
        nodes: [...],
        edges: [...]
      }
    },
    audit: {
      inconsistencies: [
        {
          type: "dead_reappear" | "missing_setup" | "faction_conflict" | "orphan_thread" | "weight_imbalance",
          severity: "error" | "warning" | "info",
          nodeIds: ["char_xxx"],
          edgeIds: ["edge_xxx"],
          chapters: [10, 15],
          message: "é—®é¢˜æè¿°"
        }
      ],
      lastAuditAt: "æ—¶é—´æˆ³"
    },
    graphGenerated: true
  },

  // ç« èŠ‚ç‹¬ç«‹å›¾è°±
  chapterGraphs: {
    "1": {
      nodes: [...],
      edges: [...]
    },
    "5": {
      nodes: [...],
      edges: [...]
    }
  },

  // ç”ŸæˆçŠ¶æ€æ ‡è®°
  architectureGenerated: false,
  blueprintGenerated: false
}
```

---

## æ ¸å¿ƒç®—æ³•ä¸é€»è¾‘

### 1. ç« èŠ‚å¤§çº²è§£æ

```javascript
// parseChapterBlueprint å‡½æ•°
// è¾“å…¥ï¼šç« èŠ‚å¤§çº²æ–‡æœ¬
// è¾“å‡ºï¼šç»“æ„åŒ–ç« èŠ‚æ•°ç»„

[
  {
    number: 1,
    title: "å¼‚è±¡åˆç°",
    position: "äº‹ä»¶å¼•å…¥",
    purpose: "æ¨è¿›å‰§æƒ…",
    suspense: "æ¸è¿›",
    foreshadowing: "åŸ‹è®¾(ç¥ç§˜ç¬¦å·)â†’å¼ºåŒ–(ä¸»è§’æ„ŸçŸ¥åŠ›)",
    twistLevel: "â˜…â˜†â˜†â˜†â˜†",
    summary: "æŸ³æºªé•‡çªç„¶å‡ºç°ç¥ç§˜ç¬¦å·..."
  }
]
```

#### æ­£åˆ™è¡¨è¾¾å¼
```
ç« èŠ‚åŒ¹é…: /ç¬¬\s*(\d+)\s*ç« \s*[-â€“â€”]\s*(.+?)(?=\n|$)/g
å­—æ®µæå–: /å­—æ®µå[ï¼š:]\s*(.+?)(?=\n|$)/
```

---

### 2. ç« èŠ‚å¤§çº²åˆ†å—ç”Ÿæˆ

```javascript
// æ ¹æ®æ¨¡å‹ maxTokens è®¡ç®—åˆ†å—å¤§å°
const tokensPerChapter = 200
const maxTokens = apiConfig.maxTokens || 8192
let chunkSize = Math.floor(maxTokens / tokensPerChapter / 10) * 10 - 10
chunkSize = Math.max(1, Math.min(chunkSize, numberOfChapters))

// ç¤ºä¾‹ï¼šmaxTokens=8192
// chunkSize = Math.floor(8192 / 200 / 10) * 10 - 10
// chunkSize = Math.floor(4.096) * 10 - 10
// chunkSize = 4 * 10 - 10 = 30
// å³æ¯æ¬¡æœ€å¤šç”Ÿæˆ 30 ç« 
```

---

### 3. ç« èŠ‚å¤§çº²é™åˆ¶æœºåˆ¶

```javascript
// é™åˆ¶å·²æœ‰å¤§çº²åˆ°æœ€è¿‘ 100 ç« 
function limitChapterBlueprint(blueprint, limit) {
  const pattern = /(ç¬¬\s*\d+\s*ç« .*?)(?=ç¬¬\s*\d+\s*ç« |$)/gs
  const chapters = blueprint.match(pattern) || []

  if (chapters.length <= limit) return blueprint

  return chapters.slice(-limit).join('\n\n').trim()
}
```

---

### 4. å‰ç« ç»“å°¾æ®µæå–

```javascript
// è·å–å‰ä¸€ç« æœ€å 800 å­—
const prevChapter = project.chapters?.[chapterNumber - 1] || ''
const previousChapterExcerpt = prevChapter.slice(-800) || '(æ— å‰ç« å†…å®¹)'
```

---

### 5. å¿«ç…§æŸ¥æ‰¾ç®—æ³•

```javascript
// æ ¹æ®ç« èŠ‚å·è·å–å¯¹åº”çš„å¿«ç…§
function getSnapshotForChapter(snapshots, chapterNum) {
  const snapshotKeys = Object.keys(snapshots).map(Number).sort((a, b) => a - b)

  // æ‰¾åˆ°å°äºç­‰äº chapterNum çš„æœ€å¤§ key
  for (let i = snapshotKeys.length - 1; i >= 0; i--) {
    if (snapshotKeys[i] <= chapterNum) {
      return snapshots[snapshotKeys[i]]
    }
  }

  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›æœ€æ—©çš„å¿«ç…§
  return snapshots[snapshotKeys[0]]
}
```

---

### 6. å›¾è°±å¢é‡åº”ç”¨

```javascript
// å°† delta åº”ç”¨åˆ°å½“å‰å¿«ç…§
function applyDelta(currentSnapshot, delta) {
  let { nodes, edges } = currentSnapshot

  // æ·»åŠ æ–°èŠ‚ç‚¹
  nodes = [...nodes, ...delta.newNodes]

  // æ›´æ–°èŠ‚ç‚¹
  nodes = nodes.map(node => {
    const update = delta.updatedNodes.find(u => u.id === node.id)
    if (update) {
      return { ...node, ...update.changes }
    }
    return node
  })

  // åˆ é™¤èŠ‚ç‚¹
  nodes = nodes.filter(node => !delta.removedNodeIds.includes(node.id))

  // åŒæ ·çš„é€»è¾‘åº”ç”¨åˆ° edges
  edges = [...edges, ...delta.newEdges]
  edges = edges.map(edge => {
    const update = delta.updatedEdges.find(u => u.id === edge.id)
    if (update) {
      return { ...edge, ...update.changes }
    }
    return edge
  })
  edges = edges.filter(edge => !delta.removedEdgeIds.includes(edge.id))

  return { nodes, edges }
}
```

---

### 7. JSON å“åº”è§£æ

```javascript
// ä» AI å“åº”ä¸­æå– JSON
function parseJsonResponse(text) {
  if (!text) return null

  // å°è¯•ç›´æ¥è§£æ
  try {
    return JSON.parse(text)
  } catch (e) {}

  // å°è¯•æå–ä»£ç å—ä¸­çš„ JSON
  const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/)
  if (codeBlockMatch) {
    try {
      return JSON.parse(codeBlockMatch[1])
    } catch (e) {}
  }

  // å°è¯•æå–èŠ±æ‹¬å·å†…å®¹
  const braceMatch = text.match(/\{[\s\S]*\}/)
  if (braceMatch) {
    try {
      return JSON.parse(braceMatch[0])
    } catch (e) {}
  }

  return null
}
```

---

### 8. æ¸…ç† AI å“åº”

```javascript
// ç§»é™¤ markdown æ ¼å¼
function cleanResponse(text) {
  if (!text) return ''

  // ç§»é™¤ markdown ä»£ç å—
  let cleaned = text.replace(/```[\s\S]*?```/g, '')
  cleaned = cleaned.replace(/`/g, '')

  // å»é™¤ç©ºç™½
  cleaned = cleaned.trim()

  return cleaned
}
```

---

## ç»„ä»¶åŠŸèƒ½è¯¦è§£

### ProjectCard.vueï¼ˆé¡¹ç›®å¡ç‰‡ï¼‰

#### Props
```javascript
{
  project: {
    type: Object,
    required: true
  }
}
```

#### Emits
```javascript
@click       // ç‚¹å‡»å¡ç‰‡
@delete      // ç‚¹å‡»åˆ é™¤æŒ‰é’®
```

#### çŠ¶æ€è®¡ç®—
```javascript
// çŠ¶æ€åˆ¤å®šé€»è¾‘
if (blueprintGenerated) return { text: 'å¤§çº²å·²ç”Ÿæˆ', type: 'success' }
if (architectureGenerated) return { text: 'æ¶æ„å·²ç”Ÿæˆ', type: 'warning' }
return { text: 'å¾…ç”Ÿæˆ', type: 'info' }

// è¿›åº¦è®¡ç®—
let completed = 0
if (coreSeed) completed++
if (characterDynamics) completed++
if (worldBuilding) completed++
if (plotArchitecture) completed++
if (chapterBlueprint) completed++
return Math.round((completed / 5) * 100)
```

---

### ArchitecturePanel.vueï¼ˆæ¶æ„é¢æ¿ï¼‰

#### Props
```javascript
{
  project: Object,
  isGenerating: Boolean
}
```

#### Emits
```javascript
@generate    // ç”Ÿæˆæ¶æ„
@regenerate  // é‡æ–°ç”Ÿæˆ
```

#### å±•å¼€çŠ¶æ€ç®¡ç†
```javascript
const expandedSections = ref([
  'coreSeed',
  'characterDynamics',
  'worldBuilding',
  'plotArchitecture'
])
```

#### åŒºåŸŸé…ç½®
```javascript
const sections = [
  { key: 'coreSeed', title: 'æ ¸å¿ƒç§å­', icon: LocateOutline, color: 'from-rose-500 to-orange-500' },
  { key: 'characterDynamics', title: 'è§’è‰²ä½“ç³»', icon: PersonOutline, color: 'from-blue-500 to-cyan-500' },
  { key: 'worldBuilding', title: 'ä¸–ç•Œè§‚', icon: GlobeOutline, color: 'from-emerald-500 to-teal-500' },
  { key: 'plotArchitecture', title: 'æƒ…èŠ‚æ¶æ„', icon: TrendingUpOutline, color: 'from-violet-500 to-purple-500' },
  { key: 'characterState', title: 'è§’è‰²çŠ¶æ€', icon: DocumentTextOutline, color: 'from-amber-500 to-yellow-500' }
]
```

---

### ChapterBlueprintPanel.vueï¼ˆå¤§çº²é¢æ¿ï¼‰

#### Props
```javascript
{
  project: Object,
  chapters: Array,  // è§£æåçš„ç« èŠ‚
  isGenerating: Boolean,
  architectureGenerated: Boolean
}
```

#### Emits
```javascript
@generate    // ç”Ÿæˆå¤§çº²
@regenerate  // é‡æ–°ç”Ÿæˆ
```

#### åŠŸèƒ½ç‰¹ç‚¹
- æŠ˜å é¢æ¿å±•ç¤ºå„ç« èŠ‚
- å¯ç¼–è¾‘æ–‡æœ¬æ¡†
- ç« èŠ‚ä¿¡æ¯æ ‡ç­¾å±•ç¤º
- ç”ŸæˆçŠ¶æ€åé¦ˆ

---

### ChapterWriterPanel.vueï¼ˆå†™ä½œé¢æ¿ï¼‰

#### Props
```javascript
{
  project: Object,
  isGenerating: Boolean
}
```

#### Emits
```javascript
@update:is-generating  // æ›´æ–°ç”ŸæˆçŠ¶æ€
```

#### æ ¸å¿ƒçŠ¶æ€
```javascript
const currentChapter = ref(1)           // å½“å‰ç« èŠ‚
const chapterContent = ref('')          // ç« èŠ‚å†…å®¹
const generationStep = ref('')          // ç”Ÿæˆæ­¥éª¤
const graphGenerating = ref(false)      // å›¾è°±ç”Ÿæˆä¸­
const graphStep = ref('')               // å›¾è°±ç”Ÿæˆæ­¥éª¤
```

#### è®¡ç®—å±æ€§
```javascript
// ä¸‹ä¸€ä¸ªè¦å†™çš„ç« èŠ‚
const nextChapterToWrite = computed(() => {
  const chapters = project?.chapters || {}
  for (let i = 1; i <= project?.numberOfChapters; i++) {
    if (!chapters[i]) return i
  }
  return project?.numberOfChapters || 1
})

// å½“å‰ç« èŠ‚ä¿¡æ¯
const currentChapterInfo = computed(() => {
  return blueprintChapters.value.find(c => c.number === currentChapter.value)
})

// ç« èŠ‚æ˜¯å¦å­˜åœ¨
const chapterExists = computed(() => {
  return !!project?.chapters?.[currentChapter.value]
})

// å½“å‰ç« èŠ‚å›¾è°±
const currentChapterGraph = computed(() => {
  return project?.chapterGraphs?.[currentChapter.value] || null
})
```

#### æ“ä½œæµç¨‹

**1. ç”Ÿæˆè‰ç¨¿**
```javascript
// æ£€æŸ¥å‰ç½®æ¡ä»¶
if (!apiConfig) return message.warning('è¯·å…ˆé…ç½® API Key')
if (!blueprintGenerated) return message.warning('è¯·å…ˆç”Ÿæˆç« èŠ‚å¤§çº²')

// è·³ç« æç¤º
if (currentChapter > 1 && !prevChapterExists) {
  // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
}

// è°ƒç”¨ç”Ÿæˆ API
const draft = await generateChapterDraft(project, currentChapter, config, onProgress)
chapterContent.value = draft
```

**2. ä¿å­˜å¹¶å®šç¨¿**
```javascript
// ä¿å­˜ç« èŠ‚å†…å®¹
const updatedChapters = { ...project.chapters, [currentChapter]: chapterContent }

// å®šç¨¿ï¼ˆæ›´æ–°æ‘˜è¦å’Œè§’è‰²çŠ¶æ€ï¼‰
const updates = await finalizeChapter(project, currentChapter, chapterContent, config)

// æ›´æ–°é¡¹ç›®
novelStore.updateProject(project.id, {
  chapters: updatedChapters,
  ...updates  // globalSummary, characterState
})

// åå°ç”Ÿæˆç« èŠ‚å›¾è°±
generateChapterGraphData(currentChapter, chapterContent)

// è‡ªåŠ¨è·³è½¬ä¸‹ä¸€ç« 
if (currentChapter < numberOfChapters) {
  currentChapter++
  chapterContent = ''
}
```

**3. å¿«é€Ÿä¿å­˜**
```javascript
// ä»…ä¿å­˜å†…å®¹ï¼Œä¸æ›´æ–°ä¸Šä¸‹æ–‡
const updatedChapters = { ...project.chapters, [currentChapter]: chapterContent }
novelStore.updateProject(project.id, { chapters: updatedChapters })
```

**4. æ‰©å†™**
```javascript
const enriched = await enrichChapter(chapterContent, wordNumber, config)
chapterContent.value = enriched
```

---

### InspirationCompass.vueï¼ˆçµæ„Ÿç½—ç›˜ï¼‰

#### Props
```javascript
{
  project: Object,
  isGenerating: Boolean
}
```

#### Emits
```javascript
@update:is-generating  // æ›´æ–°ç”ŸæˆçŠ¶æ€
```

#### æ ¸å¿ƒçŠ¶æ€
```javascript
const graphRef = ref(null)
const sidebarVisible = ref(false)
const selectedNode = ref(null)
const selectedEdge = ref(null)
const popoverVisible = ref(false)
const popoverPos = ref({ x: 0, y: 0 })
const currentChapter = ref(0)
```

#### è®¡ç®—å±æ€§
```javascript
// å½“å‰å¿«ç…§
const currentSnapshot = computed(() => {
  if (!graphData?.snapshots) return null
  return getSnapshotForChapter(graphData.snapshots, currentChapter.value)
})

// æ‰€æœ‰èŠ‚ç‚¹å’Œè¾¹
const allNodes = computed(() => currentSnapshot.value?.nodes || [])
const allEdges = computed(() => currentSnapshot.value?.edges || [])
```

#### æ“ä½œæµç¨‹

**1. ç”ŸæˆåŸºçº¿å›¾è°±**
```javascript
const result = await generateBaseGraph(project, config, onProgress)
novelStore.updateProject(project.id, { graphData: result })
currentChapter.value = 0
```

**2. æ›´æ–°ç« èŠ‚å¿«ç…§**
```javascript
const result = await generateChapterSnapshots(project, config, onProgress)
novelStore.updateProject(project.id, { graphData: result })
```

**3. èŠ‚ç‚¹ç‚¹å‡»**
```javascript
function handleNodeClick(nodeId) {
  const node = allNodes.value.find(n => n.id === nodeId)
  selectedNode.value = node
  sidebarVisible.value = true
  popoverVisible.value = false
}
```

**4. å…³ç³»ç‚¹å‡»**
```javascript
function handleEdgeClick(edgeId) {
  const edge = allEdges.value.find(e => e.id === edgeId)
  selectedEdge.value = edge
  popoverPos.value = { x: window.innerWidth / 2 - 144, y: window.innerHeight / 2 - 100 }
  popoverVisible.value = true
}
```

**5. åˆ é™¤èŠ‚ç‚¹**
```javascript
// 1. æ‰¾å‡ºå—å½±å“çš„ç« èŠ‚
const affectedChapters = []
for (const [ch, snap] of Object.entries(snapshots)) {
  if (snap.nodes.some(n => n.id === nodeId) || snap.edges.some(e => e.source === nodeId || e.target === nodeId)) {
    affectedChapters.push(ch)
  }
}

// 2. ç¡®è®¤åˆ é™¤
dialog.warning({
  content: `åˆ é™¤ã€Œ${node.label}ã€å°†å½±å“ ${affectedChapters.length} ä¸ªç« èŠ‚`,
  onPositiveClick: () => {
    // 3. ä»æ‰€æœ‰å¿«ç…§ä¸­åˆ é™¤
    const updatedSnapshots = { ...snapshots }
    for (const [ch, snap] of Object.entries(updatedSnapshots)) {
      updatedSnapshots[ch] = {
        nodes: snap.nodes.filter(n => n.id !== nodeId),
        edges: snap.edges.filter(e => e.source !== nodeId && e.target !== nodeId)
      }
    }
    novelStore.updateProject(project.id, { graphData: { ...graphData, snapshots: updatedSnapshots } })
  }
})
```

**6. å¯¼å‡º PNG**
```javascript
const dataUrl = await graphRef.value.exportPNG()
const a = document.createElement('a')
a.href = dataUrl
a.download = `${project.title}-å…³ç³»å›¾è°±.png`
a.click()
```

**7. å¯¼å‡º HTML**
```javascript
const html = generateExportHTML(graphData, project.title)
const blob = new Blob([html], { type: 'text/html;charset=utf-8' })
const url = URL.createObjectURL(blob)
const a = document.createElement('a')
a.href = url
a.download = `${project.title}-å…³ç³»å›¾è°±.html`
a.click()
URL.revokeObjectURL(url)
```

---

### CompassGraph.vueï¼ˆå…³ç³»å›¾è°±ç”»å¸ƒï¼‰

#### Props
```javascript
{
  snapshot: Object,      // å½“å‰å¿«ç…§æ•°æ®
  focusNodeId: String    // èšç„¦èŠ‚ç‚¹ ID
}
```

#### Emits
```javascript
@node-click       // èŠ‚ç‚¹ç‚¹å‡»
@edge-click       // å…³ç³»ç‚¹å‡»
@node-dblclick    // èŠ‚ç‚¹åŒå‡»
@canvas-dblclick  // ç”»å¸ƒåŒå‡»
```

#### å¯¼å‡ºæ–¹æ³•
```javascript
// æš´éœ²ç»™çˆ¶ç»„ä»¶è°ƒç”¨
exportPNG() {
  // è¿”å› dataURL
}
```

#### å¯è§†åŒ–å®ç°
- ä½¿ç”¨ ECharts å›¾åº“
- åŠ›å¯¼å‘å¸ƒå±€
- èŠ‚ç‚¹é¢œè‰²æŒ‰ç±»å‹åŒºåˆ†
- å…³ç³»çº¿æ¡ç²—ç»†æŒ‰å¼ºåº¦åŒºåˆ†
- èšç„¦æ¨¡å¼ï¼šä»…æ˜¾ç¤ºç„¦ç‚¹èŠ‚ç‚¹åŠå…¶å…³è”

---

### CompassSidebar.vueï¼ˆèŠ‚ç‚¹è¯¦æƒ…ä¾§è¾¹æ ï¼‰

#### Props
```javascript
{
  node: Object,        // é€‰ä¸­çš„èŠ‚ç‚¹
  edges: Array,        // æ‰€æœ‰å…³ç³»
  allNodes: Array,     // æ‰€æœ‰èŠ‚ç‚¹
  visible: Boolean     // æ˜¯å¦æ˜¾ç¤º
}
```

#### Emits
```javascript
@close           // å…³é—­ä¾§è¾¹æ 
@delete-node     // åˆ é™¤èŠ‚ç‚¹
@locate-chapter  // å®šä½åˆ°ç« èŠ‚
```

#### å±•ç¤ºå†…å®¹
- èŠ‚ç‚¹åŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€ç±»å‹ã€ç®€ä»‹ï¼‰
- èŠ‚ç‚¹å±æ€§ï¼ˆé‡è¦æ€§ã€é˜µè¥ã€çŠ¶æ€ã€ç‰¹å¾ï¼‰
- ç›¸å…³å…³ç³»åˆ—è¡¨
- é¦–æ¬¡å‡ºç°ç« èŠ‚
- æ“ä½œæŒ‰é’®ï¼ˆåˆ é™¤ã€å®šä½ç« èŠ‚ï¼‰

---

### CompassTimeline.vueï¼ˆæ—¶é—´è½´ï¼‰

#### Props
```javascript
{
  currentChapter: Number,      // å½“å‰ç« èŠ‚
  maxChapter: Number,          // æœ€å¤§ç« èŠ‚
  snapshots: Object            // æ‰€æœ‰å¿«ç…§
}
```

#### Emits
```javascript
@change  // ç« èŠ‚å˜åŒ–
```

#### åŠŸèƒ½
- æ»‘å—å½¢å¼çš„æ—¶é—´è½´
- æ˜¾ç¤ºæœ‰å¿«ç…§çš„ç« èŠ‚æ ‡è®°
- æ‹–åŠ¨åˆ‡æ¢ç« èŠ‚

---

## API å±‚è®¾è®¡

### llm.js

```javascript
// èŠå¤©è¡¥å…¨
chatCompletion(config, prompt, onStream)
  - config: { baseUrl, apiKey, model, temperature, maxTokens, timeout }
  - prompt: æç¤ºè¯æ–‡æœ¬
  - onStream: æµå¼å›è°ƒ (content, fullContent) => {}

// æ¸…ç†å“åº”
cleanResponse(text)
  - ç§»é™¤ markdown ä»£ç å—
  - ç§»é™¤åå¼•å·
  - å»é™¤é¦–å°¾ç©ºç™½
```

### generator.js

```javascript
// ç”Ÿæˆæ¶æ„
generateArchitecture(project, apiConfig, onProgress)
  - è¿”å›: { coreSeed, characterDynamics, worldBuilding, plotArchitecture, characterState }

// ç”Ÿæˆç« èŠ‚å¤§çº²
generateChapterBlueprint(project, apiConfig, onProgress)
  - è¿”å›: å®Œæ•´ç« èŠ‚å¤§çº²æ–‡æœ¬

// è§£æç« èŠ‚å¤§çº²
parseChapterBlueprint(blueprint)
  - è¿”å›: ç»“æ„åŒ–ç« èŠ‚æ•°ç»„

// ç”Ÿæˆç« èŠ‚è‰ç¨¿
generateChapterDraft(project, chapterNumber, apiConfig, onProgress)
  - è¿”å›: ç« èŠ‚æ­£æ–‡

// å®šç¨¿ç« èŠ‚
finalizeChapter(project, chapterNumber, chapterText, apiConfig, onProgress)
  - è¿”å›: { globalSummary, characterState }

// æ‰©å†™ç« èŠ‚
enrichChapter(chapterText, wordNumber, apiConfig, onProgress)
  - è¿”å›: æ‰©å†™åçš„æ–‡æœ¬

// å¯¼å‡º TXT
exportNovelToText(project)
  - è¿”å›: TXT æ ¼å¼æ–‡æœ¬

// å¯¼å‡º Markdown
exportNovelToMarkdown(project)
  - è¿”å›: Markdown æ ¼å¼æ–‡æœ¬
```

### compass-generator.js

```javascript
// ç”ŸæˆåŸºçº¿å›¾è°±
generateBaseGraph(project, apiConfig, onProgress)
  - è¿”å›: graphData å¯¹è±¡

// ç”Ÿæˆç« èŠ‚å¿«ç…§
generateChapterSnapshots(project, apiConfig, onProgress)
  - è¿”å›: æ›´æ–°åçš„ graphData

// å®¡è®¡å›¾è°±
auditCompassGraph(project, apiConfig, onProgress)
  - è¿”å›: { inconsistencies, lastAuditAt }

// ç”Ÿæˆå•ç« å›¾è°±
generateChapterGraph(project, chapterNum, chapterText, apiConfig, onProgress)
  - è¿”å›: { nodes, edges }
```

---

## çŠ¶æ€ç®¡ç† (Pinia)

### novel.js

```javascript
state:
  - projects: Array         // é¡¹ç›®åˆ—è¡¨
  - currentProject: Object  // å½“å‰é¡¹ç›®
  - isGenerating: Boolean   // ç”ŸæˆçŠ¶æ€
  - generationProgress: String // ç”Ÿæˆè¿›åº¦

getters:
  - projectList: projects
  - hasProjects: projects.length > 0

actions:
  - createProject(projectData) -> newProject
  - updateProject(id, updates)
  - deleteProject(id)
  - setCurrentProject(id)
  - setGenerating(value, progress)
```

### settings.js

```javascript
state:
  - isDark: Boolean              // æ·±è‰²æ¨¡å¼
  - apiConfig: Object            // API é…ç½®
  - stageModels: Object          // åˆ†ç¯èŠ‚æ¨¡å‹é…ç½®

getters:
  - æ— 

actions:
  - toggleDark()
  - updateApiConfig(config)
  - updateStageModels(models)
  - getStageConfig(stage) -> config
```

---

## æœ¬åœ°å­˜å‚¨é”®å

```javascript
localStorage keys:
  - 'novel_projects': JSON.stringify(projects)
  - 'api_config': JSON.stringify(apiConfig)
  - 'stage_models': JSON.stringify(stageModels)
  - 'theme': 'dark' | 'light'
```

---

## è·¯ç”±è®¾è®¡

```javascript
routes:
  - path: '/'
    component: HomeView
    name: 'home'

  - path: '/project/:id'
    component: ProjectView
    name: 'project'
```

---

## æ ·å¼ç³»ç»Ÿ

### Tailwind é…ç½®

```javascript
// tailwind.config.js
module.exports = {
  theme: {
    extend: {
      colors: {
        // è‡ªå®šä¹‰é¢œè‰²
      }
    }
  }
}
```

### Naive UI ä¸»é¢˜

```javascript
// æ·±è‰²æ¨¡å¼
document.documentElement.classList.add('dark')

// èƒŒæ™¯è‰²
bg-white dark:bg-[#1f1f23]
bg-gray-50 dark:bg-gray-900/20

// æ–‡å­—è‰²
text-gray-800 dark:text-white
text-gray-600 dark:text-gray-300

// è¾¹æ¡†è‰²
border-gray-200/80 dark:border-gray-700/50
```

---

## æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

1. **åˆ†å—ç”Ÿæˆ**: æ ¹æ®æ¨¡å‹ maxTokens è‡ªåŠ¨è®¡ç®—åˆ†å—å¤§å°
2. **å¢é‡æ›´æ–°**: ä»…æ›´æ–°å˜åŒ–çš„æ•°æ®
3. **æ‡’åŠ è½½**: ç« èŠ‚å†…å®¹æŒ‰éœ€åŠ è½½
4. **é™åˆ¶ä¸Šä¸‹æ–‡**: å¤§çº²é™åˆ¶åˆ°æœ€è¿‘ 100 ç« 
5. **æœ¬åœ°ç¼“å­˜**: localStorage æŒä¹…åŒ–ï¼Œå‡å°‘é‡å¤è®¡ç®—

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2026-02-27
